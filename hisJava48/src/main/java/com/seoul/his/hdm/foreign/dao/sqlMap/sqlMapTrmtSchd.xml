<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.seoul.his.hdm.foreign.dao.DoctorDiagnosisDAO">
	<cache flushInterval="86400000" eviction="LRU" />
	<select id="selectCalendarList" resultType="CalendarBean">
		SELECT MIN(DECODE(d, '1', o)) sun
		     , MIN(DECODE(d, '2', o)) mon
		     , MIN(DECODE(d, '3', o)) thu
		     , MIN(DECODE(d, '4', o)) wed
		     , MIN(DECODE(d, '5', o)) THURS
		     , MIN(DECODE(d, '6', o)) FRI
		     , MIN(DECODE(d, '7', o)) SAT
		  FROM (SELECT  to_char(dt+LEVEL-1,'yyyymmdd') o
		                ,TRUNC  (dt + LEVEL - 1, 'd') w
		             , TO_CHAR(dt + LEVEL - 1, 'd') d
		             , LPAD(LEVEL, 2, '0') dd
		        FROM (SELECT TO_DATE(#{yearMonth},'yyyymm') dt FROM dual)
		        CONNECT BY LEVEL <![CDATA[<]]> = TO_CHAR(LAST_DAY(dt), 'dd')
		        )
		 GROUP BY w
		 ORDER BY w
	</select>

	<select id="selectTrmtSchdList" resultType="TrmtSchdBean">
		select
		      a.meddate,		     
		      a.EMP_NO empNo,		      
		      a.rsvcnt,      
		      a.examtm,
       	      a.ampmflag,
        	  a.RSVPOSCNT,
              a.totcnt,
              a.COMMENTS		       
		from erp48.MC_TRMT_SCHD_MAN a 
		where a.emp_no=#{empNo}
		and meddate like #{yearMonth}||'%'
		and examtm is not null
		order by meddate, examtm		
	</select>

	<select id="selectApplyHistoryList" resultType="ApplyHistoryBean">
		SELECT MEDDATE
		FROM (SELECT ROW_NUMBER () OVER (
                           ORDER BY MEDDATE DESC) O,
              		 MEDDATE
				FROM MC_TRMT_SCHD_MAN
				where emp_no=#{empNo}
				)
		WHERE O<![CDATA[<]]>6
		ORDER BY MEDDATE
	</select>
	
	<select id="selectDayScheduleList" resultType="DaySchBean">
		WITH DAYSCHEDULE AS (SELECT EMP_NO,MEDDATE,AMPMFLAG,SUM(RSVCNT) AS RsvCnt , 
																		SUM(TOTCNT) TotCnt
		FROM MC_TRMT_SCHD_MAN
		WHERE EMP_NO=#{empNo}
		GROUP BY MEDDATE, EMP_NO,AMPMFLAG
		)
		SELECT DECODE(AM.MEDDATE,NULL,PM.MEDDATE,AM.MEDDATE) AS MEDDATE, 
						AM.RsvCnt AS amRsvCnt, AM.TotCnt AS amTotCnt,PM.RsvCnt AS pmRsvCnt,
						PM.TotCnt AS pmTotCnt
		FROM
		(SELECT *
		FROM DAYSCHEDULE
		WHERE AMPMFLAG='오전')AM
		FULL OUTER JOIN
		(SELECT * 
		FROM DAYSCHEDULE
		WHERE AMPMFLAG='오후')PM
		on AM.MEDDATE=PM.MEDDATE
		ORDER BY AM.MEDDATE
	</select>
</mapper>